<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteBuilder User Cleanup Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #1e3a8a;
            color: white;
            padding: 24px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .filters {
            padding: 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
        }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #10b981;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #059669;
        }
        
        .btn-tertiary {
            background: #6b7280;
            color: white;
        }
        
        .btn-tertiary:hover {
            background: #4b5563;
        }
        
        .stats {
            padding: 16px 24px;
            background: #eff6ff;
            border-bottom: 1px solid #bfdbfe;
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a8a;
            margin-top: 4px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #f1f5f9;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #cbd5e1;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }
        
        th.sortable:hover {
            background: #e2e8f0;
        }
        
        th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }
        
        th.sortable.sorted-asc::after {
            content: '↑';
            opacity: 1;
        }
        
        th.sortable.sorted-desc::after {
            content: '↓';
            opacity: 1;
        }
        
        td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-api {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-single {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-multiple {
            background: #fce7f3;
            color: #9f1239;
        }
        
        .badge-never {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .upload-zone {
            padding: 24px;
            text-align: center;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            margin: 24px;
            background: #f8fafc;
        }
        
        .upload-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .upload-input {
            display: none;
        }
        
        .upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .upload-label:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VoteBuilder User Cleanup Tool</h1>
            <p>Filter and export inactive user accounts for cleanup</p>
        </div>
        
        <div id="uploadZone" class="upload-zone">
            <h3 style="margin-bottom: 12px; color: #475569;">Load User Data</h3>
            <p style="color: #64748b; margin-bottom: 16px;">Drag and drop your CSV file here or click to browse</p>
            <input type="file" id="fileInput" class="upload-input" accept=".csv">
            <label for="fileInput" class="upload-label">Choose File</label>
        </div>
        
        <div id="mainContent" style="display: none;">
            <div class="filters">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>User Category</label>
                        <select id="categoryFilter">
                            <option value="all">All Users</option>
                            <option value="Single Committee">Single Committee</option>
                            <option value="Multiple Committees">Multiple Committees</option>
                            <option value="API User">API Users</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Days Since Login (Min)</label>
                        <input type="number" id="minDaysFilter" placeholder="e.g., 365">
                    </div>
                    
                    <div class="filter-group">
                        <label>Days Since Login (Max)</label>
                        <input type="number" id="maxDaysFilter" placeholder="e.g., 730">
                    </div>
                    
                    <div class="filter-group">
                        <label>Committee Name (contains)</label>
                        <input type="text" id="committeeFilter" placeholder="Search committee...">
                    </div>
                    
                    <div class="filter-group">
                        <label>Include Profiles (comma-separated)</label>
                        <input type="text" id="includeProfiles" placeholder="e.g., Admin, Data Entry">
                    </div>
                    
                    <div class="filter-group">
                        <label>Exclude Profiles (comma-separated)</label>
                        <input type="text" id="excludeProfiles" placeholder="e.g., View Only, Guest">
                    </div>
                </div>
                
                <div class="checkbox-group" style="margin-top: 12px;">
                    <input type="checkbox" id="excludeApiUsers" checked>
                    <label for="excludeApiUsers">Exclude API Users</label>
                </div>
                
                <div class="checkbox-group" style="margin-top: 8px;">
                    <input type="checkbox" id="neverLoggedIn">
                    <label for="neverLoggedIn">Only Never Logged In</label>
                </div>
                
                <div class="checkbox-group" style="margin-top: 8px;">
                    <input type="checkbox" id="excludeNeverLoggedIn">
                    <label for="excludeNeverLoggedIn">Exclude Never Logged In</label>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="exportFiltered()">Export Filtered CSV</button>
                    <button class="btn btn-tertiary" onclick="resetFilters()">Reset</button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <span class="stat-label">Total Users</span>
                    <span class="stat-value" id="totalUsers">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Filtered Results</span>
                    <span class="stat-value" id="filteredUsers">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Never Logged In</span>
                    <span class="stat-value" id="neverLoggedCount">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Multi-Committee</span>
                    <span class="stat-value" id="multiCommitteeCount">0</span>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Last Login</th>
                            <th class="sortable sorted-desc" onclick="sortTable('days_since_last_login_numeric')">Days Since Login</th>
                            <th># Committees</th>
                            <th class="sortable" onclick="sortTable('committee_names')">Committee Names</th>
                            <th class="sortable" onclick="sortTable('myv_profile_name')">Profile</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let sortColumn = 'days_since_last_login_numeric';
        let sortDirection = 'desc';
        
        // File upload handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) loadCSV(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadCSV(file);
        });
        
        function loadCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allData = results.data;
                    filteredData = [...allData];
                    
                    document.getElementById('uploadZone').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    updateStats();
                    renderTable();
                }
            });
        }
        
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const minDays = document.getElementById('minDaysFilter').value;
            const maxDays = document.getElementById('maxDaysFilter').value;
            const committee = document.getElementById('committeeFilter').value.toLowerCase();
            const includeProfilesInput = document.getElementById('includeProfiles').value;
            const excludeProfilesInput = document.getElementById('excludeProfiles').value;
            const excludeApi = document.getElementById('excludeApiUsers').checked;
            const neverLoggedOnly = document.getElementById('neverLoggedIn').checked;
            const excludeNeverLogged = document.getElementById('excludeNeverLoggedIn').checked;
            
            // Parse profile filters
            const includeProfiles = includeProfilesInput 
                ? includeProfilesInput.split(',').map(p => p.trim().toLowerCase()).filter(p => p)
                : [];
            const excludeProfiles = excludeProfilesInput 
                ? excludeProfilesInput.split(',').map(p => p.trim().toLowerCase()).filter(p => p)
                : [];
            
            filteredData = allData.filter(row => {
                // Category filter
                if (category !== 'all' && row.user_category !== category) return false;
                
                // Exclude API users
                if (excludeApi && row.user_category === 'API User') return false;
                
                // Never logged in filter (only)
                if (neverLoggedOnly && row.days_since_last_login !== 'Never Logged In') return false;
                
                // Exclude never logged in
                if (excludeNeverLogged && row.days_since_last_login === 'Never Logged In') return false;
                
                // Min days filter
                if (minDays && row.days_since_last_login_numeric) {
                    const days = parseInt(row.days_since_last_login_numeric);
                    if (days < parseInt(minDays)) return false;
                }
                
                // Max days filter
                if (maxDays && row.days_since_last_login_numeric) {
                    const days = parseInt(row.days_since_last_login_numeric);
                    if (days > parseInt(maxDays)) return false;
                }
                
                // Committee filter
                if (committee && !row.committee_names.toLowerCase().includes(committee)) return false;
                
                // Profile filters
                const userProfile = (row.myv_profile_name || '').toLowerCase();
                
                // Include profiles - if specified, user must have one of these profiles
                if (includeProfiles.length > 0) {
                    const hasIncludedProfile = includeProfiles.some(profile => 
                        userProfile.includes(profile)
                    );
                    if (!hasIncludedProfile) return false;
                }
                
                // Exclude profiles - if specified, user must NOT have any of these profiles
                if (excludeProfiles.length > 0) {
                    const hasExcludedProfile = excludeProfiles.some(profile => 
                        userProfile.includes(profile)
                    );
                    if (hasExcludedProfile) return false;
                }
                
                return true;
            });
            
            updateStats();
            renderTable();
        }
        
        function resetFilters() {
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('minDaysFilter').value = '';
            document.getElementById('maxDaysFilter').value = '';
            document.getElementById('committeeFilter').value = '';
            document.getElementById('includeProfiles').value = '';
            document.getElementById('excludeProfiles').value = '';
            document.getElementById('excludeApiUsers').checked = true;
            document.getElementById('neverLoggedIn').checked = false;
            document.getElementById('excludeNeverLoggedIn').checked = false;
            
            filteredData = [...allData];
            updateStats();
            renderTable();
        }
        
        function updateStats() {
            document.getElementById('totalUsers').textContent = allData.length.toLocaleString();
            document.getElementById('filteredUsers').textContent = filteredData.length.toLocaleString();
            
            const neverLogged = allData.filter(r => r.days_since_last_login === 'Never Logged In').length;
            document.getElementById('neverLoggedCount').textContent = neverLogged.toLocaleString();
            
            const multiCommittee = allData.filter(r => parseInt(r.num_committees) > 1).length;
            document.getElementById('multiCommitteeCount').textContent = multiCommittee.toLocaleString();
        }
        
        function sortTable(column) {
            // Toggle direction if clicking same column, otherwise default to desc for days, asc for text
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = column === 'days_since_last_login_numeric' ? 'desc' : 'asc';
            }
            
            // Update header styling
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const activeHeader = document.querySelector(`th[onclick*="${column}"]`);
            if (activeHeader) {
                activeHeader.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            
            renderTable();
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Sort data based on current sort column and direction
            const sortedData = [...filteredData].sort((a, b) => {
                let valA, valB;
                
                if (sortColumn === 'days_since_last_login_numeric') {
                    valA = parseInt(a.days_since_last_login_numeric) || 0;
                    valB = parseInt(b.days_since_last_login_numeric) || 0;
                } else if (sortColumn === 'committee_names') {
                    valA = (a.committee_names || '').toLowerCase();
                    valB = (b.committee_names || '').toLowerCase();
                } else if (sortColumn === 'myv_profile_name') {
                    valA = (a.myv_profile_name || '').toLowerCase();
                    valB = (b.myv_profile_name || '').toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });
            
            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                
                let categoryBadge = '';
                if (row.user_category === 'API User') {
                    categoryBadge = '<span class="badge badge-api">API User</span>';
                } else if (row.user_category === 'Single Committee') {
                    categoryBadge = '<span class="badge badge-single">Single</span>';
                } else if (row.user_category === 'Multiple Committees') {
                    categoryBadge = '<span class="badge badge-multiple">Multiple</span>';
                }
                
                let daysDisplay = row.days_since_last_login;
                if (row.days_since_last_login === 'Never Logged In') {
                    daysDisplay = '<span class="badge badge-never">Never</span>';
                }
                
                // Format date to YYYY-MM-DD
                let formattedDate = 'Never';
                if (row.date_of_last_login && row.date_of_last_login !== 'Never') {
                    const dateObj = new Date(row.date_of_last_login);
                    formattedDate = dateObj.toISOString().split('T')[0];
                }
                
                tr.innerHTML = `
                    <td>${row.user_id}</td>
                    <td>${row.first_name} ${row.last_name}</td>
                    <td>${formattedDate}</td>
                    <td>${daysDisplay}</td>
                    <td>${row.num_committees}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${row.committee_names}">${row.committee_names}</td>
                    <td>${row.myv_profile_name || ''}</td>
                    <td>${categoryBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function exportFiltered() {
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user_cleanup_filtered_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
